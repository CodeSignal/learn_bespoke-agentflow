var w=Object.defineProperty;var L=(h,t,e)=>t in h?w(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var m=(h,t,e)=>L(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();async function E(h,t){const e=await fetch(h,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const n=await e.text();throw new Error(n||"Request failed")}return e.json()}function S(h){return E("/api/run",{graph:h})}function N(h,t){return E("/api/resume",{runId:h,input:t})}const y=240,b=420,x=["gpt-5","gpt-5-mini","gpt-5.1"],C={"gpt-5":["low","medium","high"],"gpt-5-mini":["low","medium","high"],"gpt-5.1":["none","low","medium","high"]};class A{constructor(){this.nodes=[],this.connections=[],this.nextNodeId=1,this.selectedNodeId=null,this.isDragging=!1,this.dragOffsetWorld={x:0,y:0},this.viewport={x:0,y:0,scale:1},this.isPanning=!1,this.panStart={x:0,y:0},this.viewportStart={x:0,y:0},this.tempConnection=null,this.connectionStart=null,this.reconnectingConnection=null,this.canvas=document.getElementById("canvas-container"),this.canvasStage=document.getElementById("canvas-stage"),this.nodesLayer=document.getElementById("nodes-layer"),this.connectionsLayer=document.getElementById("connections-layer"),this.chatMessages=document.getElementById("chat-messages"),this.initialPrompt=document.getElementById("initial-prompt"),this.chatStatusEl=document.getElementById("chat-status"),this.runButton=document.getElementById("btn-run"),this.rightPanel=document.getElementById("right-panel"),this.rightResizer=document.getElementById("right-resizer"),this.pendingAgentMessage=null,this.currentPrompt="",this.pendingApprovalRequest=null,this.confirmModal=document.getElementById("confirm-modal"),this.confirmTitle=document.getElementById("confirm-modal-title"),this.confirmMessage=document.getElementById("confirm-modal-message"),this.confirmConfirmBtn=document.getElementById("confirm-modal-confirm"),this.confirmCancelBtn=document.getElementById("confirm-modal-cancel"),this.confirmBackdrop=this.confirmModal?this.confirmModal.querySelector(".modal-backdrop"):null,this.initDragAndDrop(),this.initCanvasInteractions(),this.initButtons(),this.initPanelControls(),this.initWebSocket(),this.applyViewport(),this.setStatus("Idle"),this.setRunState(!1),this.addDefaultStartNode(),this.upgradeLegacyNodes(!0)}applyViewport(){this.canvasStage&&(this.canvasStage.style.transform=`translate(${this.viewport.x}px, ${this.viewport.y}px) scale(${this.viewport.scale})`)}screenToWorld(t,e){const n=this.canvas.getBoundingClientRect();return{x:(t-n.left-this.viewport.x)/this.viewport.scale,y:(e-n.top-this.viewport.y)/this.viewport.scale}}getPrimaryAgentName(){const t=this.nodes.find(e=>e.type==="agent");if(t&&t.data){const e=(t.data.agentName||"").trim();if(e)return e}return"Agent"}getNodeWidth(t){return!t||!t.data||t.data.collapsed?y:b}setStatus(t){this.chatStatusEl&&(this.chatStatusEl.innerText=t)}setRunState(t){this.isRunning=t,this.runButton&&(this.runButton.disabled=t)}logManualUserMessage(t){this.appendChatMessage(t,"user"),this.runHistory||(this.runHistory=[]),this.runHistory.push({role:"user",content:t})}showAgentSpinner(){if(!this.chatMessages)return;this.hideAgentSpinner();const t=this.getPrimaryAgentName(),e=document.createElement("div");e.className="chat-message agent spinner";const n=document.createElement("span");n.className="chat-message-label",n.textContent=`${t} agent`,e.appendChild(n);const s=document.createElement("div");s.className="chat-spinner-row";const i=document.createElement("span");i.className="chat-spinner-text",i.textContent=`${t} is working`;const o=document.createElement("span");o.className="chat-spinner",o.innerHTML="<span></span><span></span><span></span>",s.appendChild(i),s.appendChild(o),e.appendChild(s),this.chatMessages.appendChild(e),this.chatMessages.scrollTop=this.chatMessages.scrollHeight,this.pendingAgentMessage=e}hideAgentSpinner(){this.pendingAgentMessage&&(this.pendingAgentMessage.remove(),this.pendingAgentMessage=null)}renderEffortSelect(t){const e=document.createElement("select"),n=C[t.data.model]||C["gpt-5"];return n.includes(t.data.reasoningEffort)||(t.data.reasoningEffort=n[0]),n.forEach(s=>{const i=document.createElement("option");i.value=s,i.text=s.charAt(0).toUpperCase()+s.slice(1),t.data.reasoningEffort===s&&(i.selected=!0),e.appendChild(i)}),e.addEventListener("change",s=>{t.data.reasoningEffort=s.target.value}),e}zoomCanvas(t){if(!this.canvas)return;const e=Math.min(2,Math.max(.5,this.viewport.scale*t)),n=this.canvas.getBoundingClientRect(),s=n.width/2,i=n.height/2,o=(s-this.viewport.x)/this.viewport.scale,a=(i-this.viewport.y)/this.viewport.scale;this.viewport.scale=e,this.viewport.x=s-o*this.viewport.scale,this.viewport.y=i-a*this.viewport.scale,this.applyViewport()}resetViewport(){this.viewport={x:0,y:0,scale:1},this.applyViewport()}initDragAndDrop(){document.querySelectorAll(".draggable-node").forEach(e=>{e.addEventListener("dragstart",n=>{n.dataTransfer.setData("type",e.dataset.type)})}),this.canvas.addEventListener("dragover",e=>e.preventDefault()),this.canvas.addEventListener("drop",e=>{e.preventDefault();const n=e.dataTransfer.getData("type"),s=this.screenToWorld(e.clientX,e.clientY);this.addNode(n,s.x,s.y)})}initCanvasInteractions(){this.canvas&&this.canvas.addEventListener("mousedown",t=>{const e=t.target.classList&&t.target.classList.contains("canvas-hint");(t.target===this.canvas||t.target===this.canvasStage||t.target===this.connectionsLayer||t.target===this.nodesLayer||e)&&(t.preventDefault(),this.isPanning=!0,this.canvas.classList.add("panning"),this.panStart={x:t.clientX,y:t.clientY},this.viewportStart={...this.viewport})}),document.addEventListener("mousemove",t=>{if(this.isPanning){this.viewport.x=this.viewportStart.x+(t.clientX-this.panStart.x),this.viewport.y=this.viewportStart.y+(t.clientY-this.panStart.y),this.applyViewport();return}if(this.isDragging&&this.selectedNodeId){if(["INPUT","TEXTAREA","SELECT"].includes(t.target.tagName))return;const e=this.nodes.find(n=>n.id===this.selectedNodeId);if(e){const n=this.screenToWorld(t.clientX,t.clientY);e.x=n.x-this.dragOffsetWorld.x,e.y=n.y-this.dragOffsetWorld.y,this.renderNodePosition(e),this.renderConnections()}}this.tempConnection&&this.updateTempConnection(t)}),document.addEventListener("mouseup",t=>{if(this.isPanning&&(this.isPanning=!1,this.canvas&&this.canvas.classList.remove("panning")),this.isDragging=!1,this.tempConnection&&this.reconnectingConnection!==null){const e=t.target.closest(".port");e||this.renderConnections(),e||(this.reconnectingConnection=null,this.tempConnection.remove(),this.tempConnection=null,this.connectionStart=null)}else this.tempConnection&&!this.reconnectingConnection&&(this.tempConnection.remove(),this.tempConnection=null,this.connectionStart=null)})}initButtons(){document.getElementById("btn-run").addEventListener("click",()=>this.runWorkflow()),document.getElementById("btn-clear").addEventListener("click",async()=>{await this.openConfirmModal({title:"Clear Canvas",message:"Remove all nodes and connections from the canvas?",confirmLabel:"Clear",cancelLabel:"Keep"})&&(this.nodes=[],this.connections=[],this.render(),this.addDefaultStartNode(),this.currentPrompt="",this.chatMessages&&(this.chatMessages.innerHTML='<div class="chat-message system">Canvas cleared. Start building your next workflow.</div>'),this.setStatus("Idle"))}),this.approveBtn&&this.approveBtn.addEventListener("click",()=>this.submitApprovalDecision("approve")),this.rejectBtn&&this.rejectBtn.addEventListener("click",()=>this.submitApprovalDecision("reject"));const t=document.getElementById("btn-zoom-in"),e=document.getElementById("btn-zoom-out"),n=document.getElementById("btn-zoom-reset");t&&t.addEventListener("click",()=>this.zoomCanvas(1.2)),e&&e.addEventListener("click",()=>this.zoomCanvas(.8)),n&&n.addEventListener("click",()=>this.resetViewport())}initPanelControls(){if(this.rightResizer&&this.rightPanel){let t=!1;const e=s=>{if(!t)return;const i=Math.min(600,Math.max(240,window.innerWidth-s.clientX));document.documentElement.style.setProperty("--right-sidebar-width",`${i}px`)},n=()=>{t&&(t=!1,this.rightResizer.classList.remove("dragging"),document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",n))};this.rightResizer.addEventListener("mousedown",s=>{s.preventDefault(),t=!0,this.rightResizer.classList.add("dragging"),document.addEventListener("mousemove",e),document.addEventListener("mouseup",n)})}}initWebSocket(){const t=window.location.protocol==="https:"?"wss:":"ws:",e=new WebSocket(`${t}//${window.location.host}`);e.onmessage=n=>{}}openConfirmModal(t={}){const{title:e="Confirm",message:n="Are you sure?",confirmLabel:s="Confirm",cancelLabel:i="Cancel"}=t;return!this.confirmModal||!this.confirmConfirmBtn||!this.confirmCancelBtn?Promise.resolve(window.confirm(n)):(this.confirmTitle&&(this.confirmTitle.textContent=e),this.confirmMessage&&(this.confirmMessage.textContent=n),this.confirmConfirmBtn.textContent=s,this.confirmCancelBtn.textContent=i,new Promise(o=>{const a=()=>{this.confirmModal.style.display="none",this.confirmConfirmBtn.removeEventListener("click",l),this.confirmCancelBtn.removeEventListener("click",d),this.confirmBackdrop&&this.confirmBackdrop.removeEventListener("click",d),document.removeEventListener("keydown",r)},l=()=>{a(),o(!0)},d=()=>{a(),o(!1)},r=c=>{c.key==="Escape"&&d()};this.confirmModal.style.display="flex",document.addEventListener("keydown",r),this.confirmConfirmBtn.addEventListener("click",l),this.confirmCancelBtn.addEventListener("click",d),this.confirmBackdrop&&this.confirmBackdrop.addEventListener("click",d)}))}addNode(t,e,n){const s=t==="input"?"approval":t,i={id:`node_${this.nextNodeId++}`,type:s,x:e,y:n,data:this.getDefaultData(s)};this.nodes.push(i),this.renderNode(i)}upgradeLegacyNodes(t=!1){let e=!1;this.nodes.forEach(n=>{n.type==="input"&&(n.type="approval",n.data&&n.data.prompt===void 0&&(n.data.prompt="Review and approve this step."),e=!0)}),e&&t&&this.render()}addDefaultStartNode(){if(this.nodes.some(s=>s.type==="start"))return;const{x:e,y:n}=this.getDefaultStartPosition();this.addNode("start",e,n)}getDefaultStartPosition(){const t=this.canvasStage||this.canvas,e={x:160,y:160};if(!t)return e;const n=t.getBoundingClientRect(),s=n.width?Math.max(60,n.width*.2):e.x,i=n.height?Math.max(60,n.height*.3):e.y;return{x:s,y:i}}getDefaultData(t){switch(t){case"agent":return{agentName:"Agent",systemPrompt:"You are a helpful assistant.",userPrompt:"",model:"gpt-5",reasoningEffort:"low",tools:{web_search:!1},collapsed:!0};case"if":return{condition:"",collapsed:!0};case"approval":return{prompt:"Review and approve this step.",collapsed:!0};case"start":case"end":return{collapsed:!0};default:return{collapsed:!0}}}nodeHasSettings(t){return t?["agent","if","approval"].includes(t.type):!1}deleteNode(t){this.nodes=this.nodes.filter(e=>e.id!==t),this.connections=this.connections.filter(e=>e.source!==t&&e.target!==t),this.render()}render(){this.nodesLayer.innerHTML="",this.connectionsLayer.innerHTML="",this.nodes.forEach(t=>this.renderNode(t)),this.renderConnections()}renderNode(t){const e=document.createElement("div");e.className=`node ${t.type==="start"?"start-node":""}`,e.id=t.id,e.style.left=`${t.x}px`,e.style.top=`${t.y}px`,e.dataset.nodeId=t.id,t.data||(t.data={}),t.data.collapsed===void 0&&(t.data.collapsed=t.type==="start"||t.type==="end");const n=this.nodeHasSettings(t);e.classList.toggle("expanded",!t.data.collapsed);const s=document.createElement("div");s.className="node-header";const i=document.createElement("span");i.innerHTML=this.getNodeLabel(t),s.appendChild(i);const o=document.createElement("div");o.className="node-controls";let a=null,l=()=>{};n&&(a=document.createElement("button"),a.className="icon-btn collapse",a.innerHTML='<span class="material-icons">tune</span>',l=()=>{a.title=t.data.collapsed?"Open settings":"Close settings",e.classList.toggle("expanded",!t.data.collapsed)},l(),a.addEventListener("mousedown",p=>{p.stopPropagation(),t.data.collapsed=!t.data.collapsed,l(),this.renderConnections()}),o.appendChild(a));let d=null;t.type!=="start"&&(d=document.createElement("button"),d.className="icon-btn delete",d.innerHTML='<span class="material-icons">delete</span>',d.title="Delete Node",d.addEventListener("mousedown",async p=>{p.stopPropagation(),await this.openConfirmModal({title:"Delete Node",message:"Delete this node and its connections?",confirmLabel:"Delete",cancelLabel:"Cancel"})&&this.deleteNode(t.id)}),o.appendChild(d)),s.appendChild(o),s.addEventListener("mousedown",p=>{const u=a&&a.contains(p.target),g=d&&d.contains(p.target);if(u||g)return;p.stopPropagation(),this.selectNode(t.id),this.isDragging=!0;const v=this.screenToWorld(p.clientX,p.clientY);this.dragOffsetWorld={x:v.x-t.x,y:v.y-t.y}}),s.addEventListener("dblclick",p=>{n&&(p.stopPropagation(),t.data.collapsed=!t.data.collapsed,l(),this.renderConnections())}),e.appendChild(s);const r=document.createElement("div");r.className="node-preview",r.innerText=this.getNodePreviewText(t),e.appendChild(r);const c=document.createElement("div");c.className="node-body node-form",this.renderNodeForm(t,c),e.appendChild(c),this.renderPorts(t,e),this.nodesLayer.appendChild(e)}updateNodeHeader(t){const e=document.getElementById(t.id);if(!e)return;const n=e.querySelector(".node-header span");n&&(n.innerHTML=this.getNodeLabel(t))}renderNodePosition(t){const e=document.getElementById(t.id);e&&(e.style.left=`${t.x}px`,e.style.top=`${t.y}px`)}getNodeLabel(t){return t.type==="agent"?`<span class="material-symbols-outlined">network_intelligence</span>${(t.data.agentName||"Agent").trim()||"Agent"}`:t.type==="start"?'<span class="material-icons">play_circle</span>Start':t.type==="end"?'<span class="material-icons">flag</span>End':t.type==="if"?'<span class="material-icons">call_split</span>If/Else':t.type==="approval"?'<span class="material-symbols-outlined">thumbs_up_down</span>User Approval':t.type}getNodePreviewText(t){if(t.type==="agent"){const e=(t.data.agentName||"Agent").trim(),n=(t.data.model||"gpt-5").toUpperCase();return`${e} • ${n}`}return t.type==="if"?`Condition: ${t.data.condition||"..."} `:t.type==="approval"?t.data.prompt||"Approval message required":t.type==="start"?"Uses Initial Prompt":"Configure this node"}renderNodeForm(t,e){e.innerHTML="";const n=s=>{const i=document.createElement("label");return i.textContent=s,i};if(t.type==="agent"){e.appendChild(n("Agent Name"));const s=document.createElement("input");s.type="text",s.value=t.data.agentName||"Agent",s.placeholder="e.g., Research Agent",s.addEventListener("input",r=>{t.data.agentName=r.target.value,this.updatePreview(t),this.updateNodeHeader(t)}),e.appendChild(s),e.appendChild(n("System Prompt"));const i=document.createElement("textarea");i.value=t.data.systemPrompt||"",i.addEventListener("input",r=>{t.data.systemPrompt=r.target.value,this.updatePreview(t)}),e.appendChild(i),e.appendChild(n("User Prompt Override (optional)"));const o=document.createElement("textarea");o.placeholder="If left empty, uses previous node output.",o.value=t.data.userPrompt||"",o.addEventListener("input",r=>{t.data.userPrompt=r.target.value}),e.appendChild(o),e.appendChild(n("Model"));const a=document.createElement("select");x.forEach(r=>{const c=document.createElement("option");c.value=r,c.text=r.toUpperCase(),t.data.model===r&&(c.selected=!0),a.appendChild(c)}),a.addEventListener("change",r=>{t.data.model=r.target.value,this.updatePreview(t),this.render()}),e.appendChild(a),e.appendChild(n("Reasoning Effort")),e.appendChild(this.renderEffortSelect(t)),e.appendChild(n("Tools"));const l=document.createElement("div");l.className="tool-list",[{key:"web_search",label:"Web Search"}].forEach(r=>{var u;const c=document.createElement("label");c.className="row";const p=document.createElement("input");p.type="checkbox",p.checked=((u=t.data.tools)==null?void 0:u[r.key])||!1,p.addEventListener("change",g=>{t.data.tools||(t.data.tools={}),t.data.tools[r.key]=g.target.checked}),c.appendChild(p),c.appendChild(document.createTextNode(` ${r.label}`)),l.appendChild(c)}),e.appendChild(l)}else if(t.type==="if"){e.appendChild(n("Condition (Text contains)"));const s=document.createElement("input");s.type="text",s.value=t.data.condition||"",s.addEventListener("input",i=>{t.data.condition=i.target.value,this.updatePreview(t)}),e.appendChild(s)}else if(t.type==="approval"){e.appendChild(n("Approval Message"));const s=document.createElement("input");s.type="text",s.value=t.data.prompt||"",s.placeholder="Message shown to user when approval is required",s.addEventListener("input",i=>{t.data.prompt=i.target.value}),e.appendChild(s)}else e.textContent="No configurable options for this node."}updatePreview(t){const e=document.getElementById(t.id);if(!e)return;const n=e.querySelector(".node-preview");n&&(n.innerText=this.getNodePreviewText(t))}renderPorts(t,e){if(t.type!=="start"){const n=this.createPort(t.id,"input","port-in");e.appendChild(n)}t.type!=="end"&&(t.type==="if"?(e.appendChild(this.createPort(t.id,"true","port-out port-true","True")),e.appendChild(this.createPort(t.id,"false","port-out port-false","False"))):t.type==="approval"?(e.appendChild(this.createPort(t.id,"approve","port-out port-true","Approve")),e.appendChild(this.createPort(t.id,"reject","port-out port-false","Reject"))):e.appendChild(this.createPort(t.id,"output","port-out")))}createPort(t,e,n,s=""){const i=document.createElement("div");return i.className=`port ${n}`,s&&(i.title=s),i.dataset.nodeId=t,i.dataset.handle=e,e==="input"?i.addEventListener("mouseup",o=>this.onPortMouseUp(o,t,e)):i.addEventListener("mousedown",o=>this.onPortMouseDown(o,t,e)),i}onPortMouseDown(t,e,n){if(t.stopPropagation(),t.preventDefault(),!this.connectionsLayer)return;const s=this.screenToWorld(t.clientX,t.clientY);this.connectionStart={nodeId:e,handle:n,x:s.x,y:s.y},this.tempConnection=document.createElementNS("http://www.w3.org/2000/svg","path"),this.tempConnection.setAttribute("class","connection-line"),this.tempConnection.setAttribute("d",`M ${this.connectionStart.x} ${this.connectionStart.y} L ${this.connectionStart.x} ${this.connectionStart.y}`),this.connectionsLayer.appendChild(this.tempConnection)}updateTempConnection(t){if(!this.connectionStart)return;const e=this.screenToWorld(t.clientX,t.clientY);this.tempConnection.setAttribute("d",this.getPathD(this.connectionStart.x,this.connectionStart.y,e.x,e.y))}onPortMouseUp(t,e,n){t.stopPropagation(),this.connectionStart&&this.connectionStart.nodeId!==e?(this.reconnectingConnection!==null?(this.connections.push({source:this.connectionStart.nodeId,target:e,sourceHandle:this.connectionStart.handle,targetHandle:n}),this.reconnectingConnection=null):this.connections.push({source:this.connectionStart.nodeId,target:e,sourceHandle:this.connectionStart.handle,targetHandle:n}),this.renderConnections(),this.tempConnection&&this.tempConnection.remove(),this.connectionStart=null,this.tempConnection=null):this.reconnectingConnection!==null&&(this.reconnectingConnection=null,this.renderConnections(),this.tempConnection&&this.tempConnection.remove(),this.connectionStart=null,this.tempConnection=null)}onConnectionLineMouseDown(t,e,n){if(t.stopPropagation(),t.preventDefault(),!this.connectionsLayer)return;this.reconnectingConnection=n;const s=this.nodes.find(d=>d.id===e.source);if(!s)return;let i=24;(e.sourceHandle==="true"||e.sourceHandle==="approve")&&(i=51),(e.sourceHandle==="false"||e.sourceHandle==="reject")&&(i=81),e.sourceHandle==="output"&&s.type==="agent"&&(i=24);const o=s.x+this.getNodeWidth(s),a=s.y+i,l=this.screenToWorld(t.clientX,t.clientY);this.connectionStart={nodeId:e.source,handle:e.sourceHandle,x:o,y:a},this.connections.splice(n,1),this.renderConnections(),this.tempConnection=document.createElementNS("http://www.w3.org/2000/svg","path"),this.tempConnection.setAttribute("class","connection-line reconnecting"),this.tempConnection.setAttribute("d",this.getPathD(o,a,l.x,l.y)),this.connectionsLayer.appendChild(this.tempConnection)}renderConnections(){if(!this.connectionsLayer)return;Array.from(this.connectionsLayer.querySelectorAll(".connection-line")).forEach(e=>{e!==this.tempConnection&&e.remove()}),this.connections.forEach((e,n)=>{const s=this.nodes.find(p=>p.id===e.source),i=this.nodes.find(p=>p.id===e.target);if(!s||!i)return;let o=24;(e.sourceHandle==="true"||e.sourceHandle==="approve")&&(o=51),(e.sourceHandle==="false"||e.sourceHandle==="reject")&&(o=81),e.sourceHandle==="output"&&s.type==="agent"&&(o=24);const a=s.x+this.getNodeWidth(s),l=s.y+o,d=i.x,r=i.y+24,c=document.createElementNS("http://www.w3.org/2000/svg","path");c.setAttribute("class","connection-line editable"),c.setAttribute("d",this.getPathD(a,l,d,r)),c.dataset.connectionIndex=n,c.dataset.sourceNodeId=e.source,c.dataset.sourceHandle=e.sourceHandle,c.dataset.targetNodeId=e.target,c.addEventListener("mousedown",p=>this.onConnectionLineMouseDown(p,e,n)),this.connectionsLayer.appendChild(c)})}getPathD(t,e,n,s){const i=Math.abs(n-t)*.5;return`M ${t} ${e} C ${t+i} ${e}, ${n-i} ${s}, ${n} ${s}`}formatApprovalMessage(t,e){const n=t==="approve"?"User approved this step.":"User rejected this step.",s=(e||"").trim();return s?`${n} Feedback: ${s}`:n}replaceApprovalWithResult(t,e){var r;if(!((r=this.pendingApprovalRequest)!=null&&r.container))return;const n=this.pendingApprovalRequest.container;n.className="chat-message approval-result",n.classList.add(t==="approve"?"approved":"rejected");const s=(e||"").trim(),i=t==="approve"?"✓":"✗",o=t==="approve"?"Approved":"Rejected";n.innerHTML="";const a=document.createElement("div");a.className="approval-result-content";const l=document.createElement("span");l.className="approval-result-icon",l.textContent=i,a.appendChild(l);const d=document.createElement("span");if(d.className="approval-result-text",d.textContent=o,a.appendChild(d),s){const c=document.createElement("div");c.className="approval-result-note",c.textContent=s,a.appendChild(c)}n.appendChild(a),this.pendingApprovalRequest=null}showApprovalMessage(t){var d;if(!this.chatMessages)return;this.clearApprovalMessage();const e=this.nodes.find(r=>r.id===t),n=((d=e==null?void 0:e.data)==null?void 0:d.prompt)||"Approval required before continuing.",s=document.createElement("div");s.className="chat-message approval-request";const i=document.createElement("div");i.className="approval-text",i.textContent=n,s.appendChild(i);const o=document.createElement("div");o.className="approval-actions";const a=document.createElement("button");a.className="reject-btn",a.textContent="Reject";const l=document.createElement("button");l.className="approve-btn",l.textContent="Approve",a.addEventListener("click",()=>this.submitApprovalDecision("reject")),l.addEventListener("click",()=>this.submitApprovalDecision("approve")),o.appendChild(a),o.appendChild(l),s.appendChild(o),this.chatMessages.appendChild(s),this.chatMessages.scrollTop=this.chatMessages.scrollHeight,this.pendingApprovalRequest={nodeId:t,container:s,approveBtn:l,rejectBtn:a}}clearApprovalMessage(){var t;(t=this.pendingApprovalRequest)!=null&&t.container&&this.pendingApprovalRequest.container.remove(),this.pendingApprovalRequest=null}setApprovalButtonsDisabled(t){this.pendingApprovalRequest&&(this.pendingApprovalRequest.approveBtn.disabled=t,this.pendingApprovalRequest.rejectBtn.disabled=t)}extractWaitingNodeId(t=[]){if(!Array.isArray(t))return null;for(let e=t.length-1;e>=0;e-=1)if(t[e].type==="wait_input")return t[e].nodeId;return null}selectNode(t){this.selectedNodeId=t,document.querySelectorAll(".node").forEach(n=>n.classList.remove("selected"));const e=document.getElementById(t);e&&e.classList.add("selected")}appendChatMessage(t,e="system"){if(!this.chatMessages)return;const n=document.createElement("div");if(n.className=`chat-message ${e}`,e==="agent"){const i=document.createElement("span");i.className="chat-message-label",i.textContent=this.getPrimaryAgentName(),n.appendChild(i)}const s=document.createElement("div");s.textContent=t,n.appendChild(s),this.chatMessages.appendChild(n),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}startChatSession(t){this.chatMessages&&(this.chatMessages.innerHTML="",t&&t.trim().length>0&&this.logManualUserMessage(t.trim()),this.showAgentSpinner())}mapLogEntryToRole(t){const e=t.type||"";return e.includes("llm_response")?"agent":e.includes("input_received")||e.includes("start_prompt")?"user":null}formatLogContent(t){const e=t.content;return typeof e=="string"?e:""}renderChatFromLogs(t=[]){if(!this.chatMessages)return;this.chatMessages.innerHTML="";let e=!1;t.forEach(n=>{const s=this.mapLogEntryToRole(n);if(!s)return;s==="agent"&&!e&&(this.hideAgentSpinner(),e=!0);const i=this.formatLogContent(n);i&&this.appendChatMessage(i,s)}),e||this.showAgentSpinner()}async runWorkflow(){this.upgradeLegacyNodes();const t=this.nodes.find(n=>n.type==="start");if(!t){alert("Add a Start node and connect your workflow before running."),this.setStatus("Missing start node");return}this.setStatus("Running"),this.setRunState(!0),this.currentPrompt=this.initialPrompt.value||"",this.startChatSession(this.currentPrompt),t.data.initialInput=this.currentPrompt;const e={nodes:this.nodes,connections:this.connections};try{const n=await S(e);this.handleRunResult(n)}catch(n){this.appendChatMessage("Error: "+n.message,"error"),this.setStatus("Failed"),this.hideAgentSpinner(),this.setRunState(!1)}}handleRunResult(t){if(t.logs&&this.renderChatFromLogs(t.logs),t.status==="paused"&&t.waitingForInput){this.currentRunId=t.runId;const e=t.currentNodeId||this.extractWaitingNodeId(t.logs);this.showApprovalMessage(e),this.setStatus("Waiting for approval")}else t.status==="completed"?(this.clearApprovalMessage(),this.setStatus("Completed"),this.hideAgentSpinner(),this.setRunState(!1)):(this.clearApprovalMessage(),this.setStatus(t.status||"Idle"),t.status!=="paused"&&(this.hideAgentSpinner(),this.setRunState(!1)))}async submitApprovalDecision(t){if(!this.currentRunId)return;this.setApprovalButtonsDisabled(!0);const e="";this.replaceApprovalWithResult(t,e),this.setStatus("Running"),this.showAgentSpinner();try{const n=await N(this.currentRunId,{decision:t,note:e});this.handleRunResult(n)}catch(n){this.appendChatMessage(n.message,"error"),this.hideAgentSpinner(),this.setRunState(!1)}}}class f{constructor(t={}){m(this,"options");m(this,"isOpen",!1);m(this,"modal");m(this,"trigger",null);this.options={triggerSelector:"#btn-help",content:"",theme:"auto",...t},this.modal=this.createModal(),this.bindEvents()}static init(t){return new f(t)}open(){var e;if(this.isOpen)return;this.isOpen=!0,this.modal.style.display="flex",document.body.style.overflow="hidden";const t=this.modal.querySelector(".modal-close");t==null||t.focus(),(e=this.trigger)==null||e.dispatchEvent(new CustomEvent("helpModal:open",{detail:this}))}close(){var t,e;this.isOpen&&(this.isOpen=!1,this.modal.style.display="none",document.body.style.overflow="",(t=this.trigger)==null||t.focus(),(e=this.trigger)==null||e.dispatchEvent(new CustomEvent("helpModal:close",{detail:this})))}updateContent(t){const e=this.modal.querySelector(".modal-body");e&&(e.innerHTML=t)}createModal(){const t=document.createElement("div");return t.className="modal",t.style.display="none",t.innerHTML=`
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Help / User Guide</h2>
          <button class="modal-close" type="button" aria-label="Close help">×</button>
        </div>
        <div class="modal-body">${this.options.content}</div>
      </div>
    `,document.body.appendChild(t),t}bindEvents(){if(this.trigger=document.querySelector(this.options.triggerSelector),!this.trigger){console.warn(`Help trigger "${this.options.triggerSelector}" not found`);return}this.trigger.addEventListener("click",n=>{n.preventDefault(),this.open()});const t=this.modal.querySelector(".modal-close");t==null||t.addEventListener("click",()=>this.close());const e=this.modal.querySelector(".modal-backdrop");e==null||e.addEventListener("click",()=>this.close()),document.addEventListener("keydown",n=>{n.key==="Escape"&&this.isOpen&&this.close()}),this.modal.addEventListener("click",n=>{var i;const s=n.target;if(s.matches('a[href^="#"]')){n.preventDefault();const o=(i=s.getAttribute("href"))==null?void 0:i.substring(1),a=o?this.modal.querySelector(`#${o}`):null;a==null||a.scrollIntoView({behavior:"smooth"})}})}}const M=`
<nav class="toc">
  <strong>Contents</strong>
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#getting-started">Getting Started</a></li>
    <li><a href="#features">Key Features</a></li>
    <li><a href="#workflow">Workflow</a></li>
    <li><a href="#faq">FAQ</a></li>
  </ul>
</nav>

<section id="overview">
  <h2>Overview</h2>
  <p>The Agentic Workflow Builder lets you compose agent flows with Start, Agent, If/Else, Approval, and End nodes. Drag nodes, connect them, configure prompts, and run against the server-side workflow engine.</p>
</section>

<section id="getting-started">
  <h2>Getting Started</h2>
  <ol>
    <li>Drag a <strong>Start</strong> node (auto-added) and at least one <strong>Agent</strong> node onto the canvas.</li>
    <li>Connect nodes by dragging from an output port to an input port.</li>
    <li>Open node settings (gear icon) to configure prompts, models, and approvals.</li>
    <li>Enter the initial user prompt in the Run Console and click <strong>Run Workflow</strong>.</li>
  </ol>
</section>

<section id="features">
  <h2>Key Features</h2>
  <h3>Visual Canvas</h3>
  <p>Pannable/zoomable canvas with SVG connections, floating palette, and snap-friendly controls.</p>
  <h3>Inline Node Editing</h3>
  <p>Expand a node to edit prompts, branching conditions, approval text, and tool toggles.</p>
  <h3>Run Console</h3>
  <p>Chat-style log with status indicator, agent spinner, and approval prompts when workflows pause for review.</p>
</section>

<section id="workflow">
  <h2>Workflow</h2>
  <ol>
    <li><strong>Design:</strong> Add nodes, wire edges, and double-check that the Start node connects to your flow.</li>
    <li><strong>Configure:</strong> Provide model settings, prompts, and optional tools per agent node.</li>
    <li><strong>Run:</strong> Click Run Workflow. The console streams logs from the server.</li>
    <li><strong>Approve:</strong> When approval nodes are reached, respond with Approve or Reject to continue.</li>
  </ol>
</section>

<section id="faq">
  <h2>FAQ</h2>
  <details>
    <summary>Why does a workflow pause?</summary>
    <p>Approval nodes intentionally pause execution until you make a decision in the Run Console.</p>
  </details>
  <details>
    <summary>Where are run logs stored?</summary>
    <p>Each execution is saved under <code>data/runs/run_*.json</code> for later auditing.</p>
  </details>
  <details>
    <summary>Do I need an OpenAI key?</summary>
    <p>No. Without <code>OPENAI_API_KEY</code>, the engine returns mock responses. Provide the key for live model calls.</p>
  </details>
</section>
`;document.addEventListener("DOMContentLoaded",()=>{window.editor=new A,f.init({content:M})});
